<!doctype>
<html>
    <head>
        <link rel="preconnect" href="https://fonts.googleapis.com"> 
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
        <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
        <title>swiped-events demo</title>
        <meta name="viewport" content="width=device-width,height=device-height,user-scalable=no,initial-scale=1,maximum-scale=1"/>
        <script src="swiped-events.js"></script>
        <script src="bb.js"></script>
        <style>
            body { overflow: hidden; background-color: #101010;}
            div { 
                position: fixed;
                left: 0;
                right: 0;
                margin: 0;
                padding: 0;
                overflow: hidden;
                font-size: 40px;
                font-family: arial;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            h1 {
                padding-top: 15px;
                font-family: 'Press Start 2P', cursive;
                text-align: center;
                color: gray;
            }
            
    
        </style>
    </head>
    <body data-swipe-threshold='50'>
      <h1>Bendy Beams</h1>
        <div> 
        <img id="CER" src="/img/cer.png" style="display:none"/>
        <img id="CERO" src="/img/cero.png" style="display:none"/>
        <img id="CNR" src="/img/cnr.png" style="display:none"/>
        <img id="CNRO" src="/img/cnro.png" style="display:none"/>
        <img id="CSR" src="/img/csr.png" style="display:none"/>
        <img id="CSRO" src="/img/csro.png" style="display:none"/>
        <img id="CWR" src="/img/cwr.png" style="display:none"/>
        <img id="CWRO" src="/img/cwro.png" style="display:none"/>

        <img id="MNE" src="/img/mne.png" style="display:none"/>
        <img id="MNEO" src="/img/mneo.png" style="display:none"/>
        <img id="MNW" src="/img/mnw.png" style="display:none"/>
        <img id="MNWO" src="/img/mnwo.png" style="display:none"/>
        <img id="MSE" src="/img/mse.png" style="display:none"/>
        <img id="MSEO" src="/img/mseo.png" style="display:none"/>
        <img id="MSW" src="/img/msw.png" style="display:none"/>
        <img id="MSWO" src="/img/mswo.png" style="display:none"/>

        <img id="PPP" src="/img/ppp.png" style="display:none"/>
        
        <img id="SSS" src="/img/sss.png" style="display:none"/>
        <img id="SSSC" src="/img/sssc.png" style="display:none"/>
        <img id="SSSH" src="/img/sssh.png" style="display:none"/>
        <img id="SSSV" src="/img/sssv.png" style="display:none"/>

        <img id="TER" src="/img/ter.png" style="display:none"/>
        <img id="TERO" src="/img/tero.png" style="display:none"/>
        <img id="TNR" src="/img/tnr.png" style="display:none"/>
        <img id="TNRO" src="/img/tnro.png" style="display:none"/>
        <img id="TSR" src="/img/tsr.png" style="display:none"/>
        <img id="TSRO" src="/img/tsro.png" style="display:none"/>
        <img id="TWR" src="/img/twr.png" style="display:none"/>
        <img id="TWRO" src="/img/twro.png" style="display:none"/>
        
        <img id="ZZZ" src="/img/zzz.png" style="display:none"/>

        <canvas 
            id="myCanvas" 
            width="220" 
            height="220" 
            style="height:375px; background-color: black;">
            Your browser does not support the HTML canvas tag.
        </canvas>
        </div><script>
            console.log("script start");
            var levelNum=3;
            var c = document.getElementById("myCanvas");
            var ctx = c.getContext("2d");
            var imgCount = 0;
            var img = {}
            var x = 0;
            var y = 0;
            var curLevel = getLevel(levelNum);
            var squareSize=20;
            console.log("script 2");
            
function loadImages()
{
    var ids = ["PPP","ZZZ","SSS","MNE","MSE","MSW","MNW","CNR","CER","CSR","CWR","TNR","TER","TSR","TWR"];
    for(const id of ids)
    {
        img[id] = document.getElementById(id);
        img[id].addEventListener('load', function() {
            imgCount++;
            console.log(id + ":" + imgCount);
        }, false);
    }
    console.log("images loaded");
}


function getLevel(n)
{
    let result = [];
    let clj = levels[n].level;
    for(let yy=0; yy<clj.length; yy++)
    {
        let rs = clj[yy];
        let row = [];
        for(let xx=0; xx<11; xx++)
        { 
            let offset=xx*3;
            let item = rs.substring(offset+0,offset+3);
            if(item=="(P)")
            {
                x=xx;
                y=yy;
            }
            row.push(item);
        }
        result.push(row);
    }
    return result;
}

function getImageId(level,xx,yy)
{
    let id = level[yy][xx];
    if(id=="   ") id="SSS";
    if(id=="###") id="ZZZ";
    if(id=="(P)") id="SSS";
    return id;
}

function getImage(id)
{
    let image = img[id];
    //console.log("getImage id:"+id+" image:"+image);
    return image;
}

function drawLevel()
{
    for(let y=0; y<11; y++)
    {
        for(let x=0; x<11; x++)
        {
            let id = getImageId(curLevel,x,y);
            //console.log(id);
            ctx.drawImage(getImage(id), x*squareSize, y*squareSize);
        }
    }
    console.log("done");
}
            
            function init() 
            {
            
                console.log("onload start");
                loadImages();
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                drawLevel();
                ctx.drawImage(img["PPP"], x*squareSize, y*squareSize);
            }
            window.addEventListener("load", init)
            function spaceOpen(dx,dy)
            {
                if(x+dx<0) return false;
                if(x+dx>=11) return false;
                if(y+dy<0) return false;
                if(y+dy>=11) return false;
                let piece = curLevel[y+dy][x+dx];
                console.log(piece);
                if(piece=="   ") return true;
                if(piece=="(P)") return true;
                return false;
            }
            function spacePushable(dx,dy)
            {
                let piece = curLevel[y+dy][x+dx];
                if(piece[0]=='M') return true;
                return false;
            }
            function move(dx,dy)
            {
                if(spaceOpen(dx,dy))
                {
                    x=x+dx;
                    y=y+dy;
                }
                else if(spacePushable(dx,dy))
                {
                    if(spaceOpen(dx+dx,dy+dy))
                    {
                        curLevel[y+dy+dy][x+dx+dx]=curLevel[y+dy][x+dx];
                        curLevel[y+dy][x+dx]=curLevel[y][x];
                        curLevel[y][x]="   ";
                        
                        x=x+dx;
                        y=y+dy;
                    }
                }
            }
            function moveLeft()
            {
                move(-1,0);
                drawLevel();
                ctx.drawImage(img["PPP"], x*squareSize, y*squareSize);
            }
            function moveRight()
            {
                move(1,0);
                drawLevel();
                ctx.drawImage(img["PPP"], x*squareSize, y*squareSize);
            }
            function moveUp()
            {
                move(0,-1);
                drawLevel();
                ctx.drawImage(img["PPP"], x*squareSize, y*squareSize);
            }
            function moveDown()
            {
                move(0,1);
                drawLevel();
                ctx.drawImage(img["PPP"], x*squareSize, y*squareSize);
            } 
            window.onload = function() {
                document.addEventListener('swiped-left', function(e) {moveLeft(); });
                document.addEventListener('swiped-right', function(e) {moveRight(); });
                document.addEventListener('swiped-up', function(e) {moveUp(); });
                document.addEventListener('swiped-down', function(e) {moveDown(); });
            }
            function checkKey(e)
            {
                e = e || window.event;
                //ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height)
                if(e.keyCode==37) {moveLeft();}
                if(e.keyCode==39) {moveRight();}
                if(e.keyCode==38) {moveUp();}
                if(e.keyCode==40) {moveDown();}
            }
            document.onkeydown = checkKey;
            
        </script>
    </body>
</html>